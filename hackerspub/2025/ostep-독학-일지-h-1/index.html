<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>
  OSTEP 독학 일지 - H.1 | KODINGWARRIOR QUEST


</title>

<meta name="description" content="고생을 사서 하는 개발자의 여정은 앞으로도 계속됩니다." />

<link type="application/atom+xml" rel="alternate" href="https://kodingwarrior.github.io/rss.xml" title="KODINGWARRIOR QUEST" />

<link rel="stylesheet" href="/_bridgetown/static/frontend/javascript/index.GB3CIZJJ.css" />
<script src="/_bridgetown/static/frontend/javascript/index.UXERASA3.js" defer></script>


  </head>
  <body class="hackerspub_post ">
    <nav class="primary-nav">
  <ul>
      <li class="">
        <a href="/" aria-label="Home" >
          <i class="bi bi-house" aria-hidden="true"></i>
          <span class="nav-label">Home</span>
        </a>
      </li>
      <li class="">
        <a href="/about/" aria-label="About" >
          <i class="bi bi-person" aria-hidden="true"></i>
          <span class="nav-label">About</span>
        </a>
      </li>
      <li class="">
        <a href="/posts/" aria-label="Posts" >
          <i class="bi bi-pencil-square" aria-hidden="true"></i>
          <span class="nav-label">Posts</span>
        </a>
      </li>
      <li class="">
        <a href="/wiki/" aria-label="Wiki" >
          <i class="bi bi-book" aria-hidden="true"></i>
          <span class="nav-label">Wiki</span>
        </a>
      </li>
      <li class="">
        <a href="/hackerspub/" aria-label="Hackers&#39; Pub" >
          <i class="bi bi-globe2" aria-hidden="true"></i>
          <span class="nav-label">Hackers&#39; Pub</span>
        </a>
      </li>
  </ul>
</nav>


    <div class="article-wrapper">
        <main class="z-20">
          <article>
            
<article class="">
  <h1 class="text-4xl font-bold pt-5 pb-3">OSTEP 독학 일지 - H.1</h1>

  <div class="flex items-center text-sm text-gray-600 pb-5 border-b mb-8">
      <span>August 13, 2025</span>
      <span class="mx-3 block font-bold text-slate-500">.</span>
      <span>ko</span>
  </div>

    <div class="prose prose-lg max-w-none">
      <p>update: 2025-08-05</p>
<blockquote>
<p>본 글은 Operating Systems : Three Easy Pieces라는 교재를 독학하는 여정을 기록으로 남기기 위한 시리즈 글입니다.</p>
</blockquote>
<p><strong>2025-08-05</strong> 09:30</p>
<p>이제 OSTEP 독학을 본격적으로 시작하는 첫 걸음이다. 시작이 반이라고 하지 않았던가? 시작을 하려면 어떻게 해야 하는가? 먼저 xv6 커널을 띄우기 위해, 헬로월드 부터 찍고 보는 것이다. 헬로월드를 찍기 위해서 필요한 준비물들을 하나 둘 살펴보자.</p>
<h2 id="0198a420-d5a2-7cac-8635-95b91fd889ba--근데-어떻게-세팅하지">근데... 어떻게 세팅하지...? <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--근데-어떻게-세팅하지"><span aria-hidden="true"></span></a></h2>
<p>먼저 xv6를 어떻게 띄울지는 이 문서(<a href="https://github.com/remzi-arpacidusseau/ostep-projects/blob/master/INSTALL-xv6.md">https://github.com/remzi-arpacidusseau/ostep-projects/blob/master/INSTALL-xv6.md</a>) 에서 설명하고 있는데, 스텝 바이 스텝으로 따라가보자. 막상, 문서를 봤더니 macOS 기준으로 어떤 것을 설치하면 되는지에 대한 설명은 있는데, 리눅스 환경에서 어떻게 설치하면 되는지에 대한 내용은 전혀 보이지가 않는다. xv6 소스코드에 대한 언급도 RISC-V 기반은 아니어서 좀 더 찾아봐야 한다.</p>
<p>결국, 내가 실습하기 위해서 준비가 되어야 하는 것들이 아래와 같은 것들인데, 내가 지금 쓰고 있는 환경인 Ubuntu에서 어떻게 세팅하는 것인지 알아봐야 한다.</p>
<ul>
<li>RISC-V 기반의 xv6 소스코드 : <a href="https://github.com/mit-pdos/xv6-riscv">https://github.com/mit-pdos/xv6-riscv</a></li>
<li><a href="https://riscv.org/specifications/ratified/">RISC-V</a> 툴체인 : xv6 소스코드를 RISC-V 기반의 인스트럭션으로 컴파일할 수 있도록 하기 위한 64비트 RISC-V GNU 툴체인</li>
<li><a href="https://www.qemu.org">QEMU</a> : xv6 소스코드를 x86_64 프로세서 혹은 애플 실리콘 프로세서 위에서 굴릴 수 있으려면, QEMU(Quick EMUlator)라는 오픈소스 머신 에뮬레이터가 필요하다.</li>
<li>그리고, 꾸준히 실습하겠다는 마음가짐</li>
</ul>
<p>다행히도, 서울대학교의 학부 수업에서 사용되는 실습 과제 리포지토리(<a href="https://github.com/snu-csl/os-pa1/">https://github.com/snu-csl/os-pa1/</a>)에 어떻게 하면 개발 환경을 세팅할 수 있는지 친절하게 설명이 잘 되어 있다.</p>
<h3 id="0198a420-d5a2-7cac-8635-95b91fd889ba--ubuntu-기준-qemu-세팅하기">(Ubuntu 기준) QEMU 세팅하기 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--ubuntu-기준-qemu-세팅하기"><span aria-hidden="true"></span></a></h3>
<p>먼저, 빌드하는데 필수요소가 되는 패키지들을 설치한다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">$</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> sudo</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> apt-get</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> install</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> git</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> build-essential</span></span></code></pre>
<p>xv6 소스코드를 클론떠서 실습하려면 당연히, git은 당연히 설치가 되어야 한다. 그렇다면 build-essential은 왜 필요한가? build-essential 패키지에는 <strong>GCC(Gnu Compiler Collection)</strong>, <strong>G++</strong>, <strong>Make</strong>, dpkg-dev 같은 것들이 포함되어 있기 때문이다. C 기반으로 짜여있는 운영체제 소스코드를 실습하는 과정에 있어서, GCC 컴파일러는 물론이고 Make는 필수다.</p>
<p>그리고, <strong>RISC-V GNU 툴체인</strong>을 설치한다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">$</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> sudo</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> apt-get</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> install</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> gcc-riscv64-linux-gnu</span></span></code></pre>
<p>마지막으로 QEMU를 설치한다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">$</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> sudo</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> apt-get</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> install</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> qemu-system-misc</span></span></code></pre>
<p>이걸로 개발환경 세팅하는건 준비가 끝났다. 그리고 git clone으로 xv6-riscv 리포지토리를 다운로드 받고, Makefile 파일에서 명시가 되어 있는대로 <strong><code>make qemu</code></strong> 명령을 실행하면 일단은 Hello World를 띄울 수는 있게 되는 셈이다.</p>
<p><strong>2025-08-06</strong> 01:30</p>
<p>Hello World는 끝났다. Hello World도 끝났겠다, 소스코드를 하나하나 다 까보고 있는데, 이럴수가.. 어떻게 보면 당연한 소리겠지만, 외부 라이브러리를 끌어다 쓰지 않는다. stdmem.h, stdio.h 등 우리가 통상적으로 C 언어를 학습할 때 가져다 쓰는 표준 헤더 파일을 가져다 쓰는 것이 아니라 <strong>가져다 쓰는 모든 것들이 같은 프로젝트 안에서 하나하나 자체 구현되어 있다.</strong> 운영체제를 밑바닥에서 구축하는 실습 과제이니 어떻게 보면 당연할 수도 있겠다. 덕분에 소스코드 하나하나를 음미하는 맛은 있을 것 같다.</p>
<p>암튼, 이왕 할거면 재밌게 실습하자는 의미에서, 부트시퀀스가 일어나는동안 릭롤링 아스키아트가 화면에 출력되도록 <strong><code>main.c</code></strong> 파일을 커스터마이징했다.</p>
<p><img src="https://media.hackers.pub/note-media/51d999db-3955-41c9-bca8-b395d3f7c1bd.webp" alt="rick-roll"></p>
<p>이제 모든 준비가 끝났다. 헬로월드를 띄웠으니, 과제로 넘어가보자.</p>
<h2 id="0198a420-d5a2-7cac-8635-95b91fd889ba--h-1-intro-project">H.1 Intro Project <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--h-1-intro-project"><span aria-hidden="true"></span></a></h2>
<p>이젠 진짜 시작이라고 볼 수 있는 <strong>H.1 Intro Project</strong> 스텝에 도전할 차례다. 과제에 대한 설명은 <a href="https://github.com/remzi-arpacidusseau/ostep-projects/tree/master/initial-xv6">여기</a>에 있다.</p>
<p><strong>2025-08-06</strong> 23:30</p>
<p>H.1 과제에서 해야하는 일은 나만의 시스템 콜(<code>int getreadcount(void)</code>)를 정의하는 것이다. <code>getreadcount</code> 함수를 정의하는 것 자체의 요구사항은 어렵지 않다. 커널이 부팅된 이후로 유저 프로세스에서 <code>read()</code> 시스템 콜이 몇번 호출되었는지만 반환하면 된다. 간단하게 접근해보자면, 이렇게 접근할 수 있을 것이다.</p>
<ol>
<li>어떤 카운터 변수(<code>readcount</code>)를 정의한다.</li>
<li><code>read()</code> 시스템 콜이 호출될 때마다 카운터 변수의 값이 1씩 증가하게 한다 (ex. <code>readcount += 1</code>)</li>
<li><code>getreadcount()</code> 함수를 호출했을 때, <code>readcount</code> 변수에 들어있는 값을 출력한다.</li>
</ol>
<p>접근만 생각했을때는 굉장히 간단하다. 근데, <strong>어떻게 시스템 콜을 정의할 지</strong>랑, <strong>시스템 콜을 올바르게 정의했는지를 어떻게 테스트하는지</strong>가 관건이다.</p>
<h3 id="0198a420-d5a2-7cac-8635-95b91fd889ba--심층-분석">심층 분석 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--심층-분석"><span aria-hidden="true"></span></a></h3>
<p>먼저, 시스템 콜을 어떻게 정의하는지를 살펴보자.</p>
<p><strong>2025-08-08</strong> 08:50</p>
<p><strong>OSTEP</strong>에 따르면, Chapter 5(Mechanism: Limited Direct Execution)에서 시스템 콜(System Call)에 대해서 설명하고 있다. 적당히 요약하자면,</p>
<blockquote>
<p><strong>시스템 콜</strong>은 유저 프로그램에서 파일시스템 접근/프로세스 생성/메모리 확보 등을 할 수 있도록 커널에서 functionality를 제공해주는 것이다.</p>
</blockquote>
<blockquote>
<p>시스템 콜을 실행하기 위해서, <strong>프로그램은 반드시 trap 이라는 특별한 instruction을 실행해야 한다.</strong> 이 instruction은 kernel의 <strong>trap table</strong>로 점프하며 kernel mode로 privilege가 바뀌게 된다. kernel mode에서 privileged operation을 실행하고 나면, OS에서는 다시 <strong>return-from-trap</strong>이라는 instruction을 실행하여 user mode로 다시 복귀한다.</p>
</blockquote>
<p><strong>2025-08-13</strong> 20:30</p>
<p>어떤 시스템 콜을 사용할 수 있는지는 <strong>kernel/syscall.c</strong>, <strong>kernel/syscall.h</strong>에 정의되어 있다. <strong>user/user.h</strong>에서는 유저 레벨에서 커널에 접근할 수 있도록 어떤 시스템 콜을 호출할 수 있는지 나열되어 있고, <strong>kernel/sysfile.c</strong>에 각 시스템 콜이 어떻게 세부적으로 구현되어 있는지 볼 수 있다. 그리고, user/usys.pl 스크립트에서는 각 시스템 콜을 호출하는 어셈블리 코드를 자동 생성하고 있다.</p>
<p>각각의 코드들이 어떻게 유기적으로 연결되는지 살펴보자. <code>write</code> 시스템 콜을 예시로 들어보겠다</p>
<h4 id="0198a420-d5a2-7cac-8635-95b91fd889ba--유저-모드에서의-trap">유저 모드에서의 trap <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--유저-모드에서의-trap"><span aria-hidden="true"></span></a></h4>
<p>유저 모드에서 내가 <code>write()</code> 같은 함수를 부르면, 사실은 **<code>usys.S</code>**에 있는 아주 짧은 어셈블리 코드가 실행된다. 이 코드는 해당 시스템 콜 번호를 <strong><code>a7</code> 레지스터</strong>에 넣고, <code>ecall</code>을 호출한다. 이 순간, CPU는 유저 모드 → 커널 모드로 전환되고, <strong>트랩 벡터</strong>에 등록된 진입점으로 점프한다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;"># user/usys.S</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">.global</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> write</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">write</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">:</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> li a7, SYS_write</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> ecall</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> ret</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span></code></pre>
<h4 id="0198a420-d5a2-7cac-8635-95b91fd889ba--커널-모드로-진입-usertrap">커널 모드로 진입(usertrap) <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--커널-모드로-진입-usertrap"><span aria-hidden="true"></span></a></h4>
<p>커널 쪽에서는 <code>trap.c</code>의 <code>usertrap()</code> 함수가 호출된다. 여기서 &quot;이건 시스템 콜 트랩이구나&quot;를 인식하면 <code>syscall()</code> 함수를 호출해서 실제 시스템 콜 처리 경로로 넘겨준다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// user/trap.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">usertrap</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  ...</span></span>
<span class="line highlighted"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  syscall</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  ...</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  usertrapret</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span></code></pre>
<h4 id="0198a420-d5a2-7cac-8635-95b91fd889ba--시스템-콜-호출">시스템 콜 호출 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--시스템-콜-호출"><span aria-hidden="true"></span></a></h4>
<p><strong>kernel/syscall.h</strong>에는 각각의 시스템 콜에 대한 <strong>system call number</strong>라는 것이 assign(ex. fork는 1번, close는 21번)이 되어 있고, <strong>kernel/syscall.c</strong>에는 시스템 콜 테이블을 각각의 system call number로 할당된 시스템 콜을 모아놓은 배열로서 <code>syscalls</code> 배열로 정의하고 있다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/syscall.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">#</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">define</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> SYS_write</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">  16</span></span></code></pre>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/syscall.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">static</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> uint64</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> (</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">*</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">syscalls</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">[]</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> =</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">[</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">SYS_write</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">]</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">   sys_write</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">};</span></span>
<span class="line"></span></code></pre>
<p><code>syscall(void)</code> 함수는 현재 프로세스의 <code>trapframe</code>에서 **<code>a7</code> 값(=시스템 콜 번호)**을 읽고, 그 번호에 맞는 함수를 <code>syscalls[]</code> 배열에서 찾아 호출한다. 그 결과값은 다시 <code>trapframe-&gt;a0</code>에 저장되는데, 이 값이 유저 모드로 돌아갔을 때 C 함수의 반환값이 된다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/syscall.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">syscall</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> num</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  struct</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> proc </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">*</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">p </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> myproc</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  num </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;"> p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">trapframe</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">a7</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  if</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">num </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">&gt;</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;&#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> num </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">&#x3C;</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> NELEM</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">syscalls</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;&#x26;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;"> syscalls</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">[</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">num</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">])</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">    // Use num to lookup the system call function for num, call it,</span></span>
<span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">    // and store its return value in p-&gt;trapframe-&gt;a0</span></span>
<span class="line"><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">    p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">trapframe</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">a0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> =</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;"> syscalls</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">[</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">num</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">]();</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">  }</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;"> else</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">    printf</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">%d</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;"> %s</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">: unknown sys call </span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">%d\n</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span></span>
<span class="line"><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">            p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">pid</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;"> p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">name</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> num</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">    p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">trapframe</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">-&gt;</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">a0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> =</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> -</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span></code></pre>
<p>그리고, 다시 <strong>user/usys.S</strong> 코드를 보면, <code>SYS_write</code>라는 시스템 콜 번호를 a7 레지스터에 적재해놓고 ecall 명령어를 실행하면, 시스템 콜 테이블에 등록된 시스템 콜(<code>sys_write</code>)을 호출하는 부분을 확인할 수 있는데, 이 함수가 어디에 정의가 되어있는지 확인을 하고 싶다면... <strong>kernel/sysfile.c</strong>에서 <code>sys_write</code>가 어떻게 정의되어 있는지 확인할 수 있다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/sysfile.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">uint64</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">sys_write</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  struct</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> file </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">*</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">f</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> n</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  uint64 p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  argaddr</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  argint</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">2</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">n</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  if</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">argfd</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">f</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x3C;</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">    return</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> -</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  return</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> filewrite</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">f</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> n</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span>
<span class="line"></span></code></pre>
<h4 id="0198a420-d5a2-7cac-8635-95b91fd889ba--유저-모드로-복귀">유저 모드로 복귀 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--유저-모드로-복귀"><span aria-hidden="true"></span></a></h4>
<p>시스템 콜이 끝나면 <code>usertrapret()</code>이 실행돼서 커널 모드 → 유저 모드로 복귀한다. 트램폴린 코드를 거쳐 <code>sret</code> 명령으로 돌아가면, 유저 모드의 어셈블리 stub(<code>usys.S</code>)이 반환값을 그대로 받아서 내가 호출했던 <code>write()</code> 함수 호출 결과로 돌려준다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// user/trap.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">usertrap</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  ...</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  syscall</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  ...</span></span>
<span class="line highlighted"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  usertrapret</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span></code></pre>
<h3 id="0198a420-d5a2-7cac-8635-95b91fd889ba--해답">해답 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--해답"><span aria-hidden="true"></span></a></h3>
<p>여기서 내가 할 수 있는 action item은 이렇게 볼 수 있다.</p>
<ol>
<li><strong>kernel/syscall.h</strong>, <strong>kernel/syscall.c</strong> 에서 시스템 콜과 시스템 콜 번호를 짝지어주기</li>
<li><strong>kernel/sysfile.c</strong> 에서 <code>getreadcount</code> 시스템콜 구현하고, <code>read</code> 시스템 콜을 호출할 때마다 <code>readcount</code> 변수가 증가하도록 하기</li>
<li><strong>user/user.h</strong>파일을 수정해서, 유저 모드에서 <code>getreadcount</code> 시스템콜을 호출할 수 있도록 빈칸 뚫어주기</li>
<li><strong>user/usys.pl</strong>  스크립트에서 생성하는 어셈블리 코드(<strong>user/usys.S</strong>)에 <code>getreadcount</code> 시스템 콜에 대한 stub 정의하기</li>
</ol>
<p>먼저, <strong>user/usys.pl</strong> 파일에서는 <code>getreadcount</code> 시스템 콜에 대한 stub를 생성하는 코드를 추가한다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;"># user/usys.pl</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">entry(</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">getreadcount</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">);</span></span></code></pre>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;"># user/usys.S</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">.global</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> getreadcount</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">getreadcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">:</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> li a7, SYS_getreadcount</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> ecall</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> ret</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span></code></pre>
<p>그리고 <strong>user/user.h</strong> 에서는 <code>getreadcount</code> 시스템콜을 유저모드에서 호출할 수 있도록 선언하고</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// user/user.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">uint64 </span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">getreadcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span></code></pre>
<p><strong>systcall.h</strong>에서는 <code>getreadcount</code> 시스템 콜의 번호를 정의한다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/syscall.h</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">#</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">define</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> SYS_getreadcount</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">  22</span></span></code></pre>
<p><strong>syscall.c</strong>에서는 <code>syscalls</code> 배열에 시스템 콜 번호(<code>SYS_getreadcount</code>)와 <code>getreadcount</code> 시스템 콜을 짝지어 준다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/syscall.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">extern</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> u64t </span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">getreadcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">static</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> uint64</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> (</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">*</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">syscalls</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">[]</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> =</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">[</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">SYS_write</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">]</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">   sys_write</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">};</span></span>
<span class="line"></span></code></pre>
<p>그리고 <strong>sysfile.c</strong>에서는 전역 범위에서 사용되는 <code>readcount</code> 변수를 정의 후, <code>read</code> 함수가 정의된 부분에 <code>readcount</code> 변수가 증가하는 코드를 집어넣고, <code>getreadcount</code> 함수를 정의하면 된다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// kernel/sysfile.c</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">static</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> u64t readcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">uint64</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">sys_read</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  struct</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> file </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">*</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">f</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> n</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  uint64 p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  readcount </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">+=</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  argaddr</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  argint</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">2</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">n</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  if</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">argfd</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">f</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x3C;</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">    return</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> -</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  return</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> fileread</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">f</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> p</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> n</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"></span>
<span class="line highlighted"></span>
<span class="line highlighted"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">uint64</span></span>
<span class="line highlighted"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">sys_getreadcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">void</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line highlighted"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line highlighted"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  return</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> readcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line highlighted"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span></code></pre>
<h3 id="0198a420-d5a2-7cac-8635-95b91fd889ba--추가적인-고민-getreadcount의-원자성-보장하기">추가적인 고민 : getreadcount의 원자성 보장하기 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--추가적인-고민-getreadcount의-원자성-보장하기"><span aria-hidden="true"></span></a></h3>
<p><strong>2025-08-13</strong> 23:00</p>
<p>여기에 문제가 하나 있다. <code>read</code>를 할 때마다 <code>readcount</code> 라는 값이 원자적으로 증가한다는 것을 어떻게 보장할 수 있을까? 정답은 <code>readcount</code> 변수의 선언부에 <strong><code>_Atomic</code></strong> 지시어를 추가하는 것이다. <strong><code>_Atomic</code></strong>  지시어로 선언된 변수는 이에 대한 증감연산자로 인한 연산이 원자적이라는 것을 보장한다. <strong><code>_Atomic</code></strong> 타입 지시어에 대한 설명은 <a href="https://en.cppreference.com/w/c/language/atomic.html">여기</a>를 참고해보자</p>
<p>그렇다면, 실제로 원자적인지 아닌지는 어떻게 프로그램으로 테스트할 수 있을까? 우리가 해볼 수 있는 것은 프로세스를 여러개 fork 띄우고, 거기다가 read를 시행하는 횟수를 엄청 늘리는 것이다. 엄청 큰 파일을 읽는다고 하더라도 그걸 재현하는데에는 무리가 있으니, 그냥 무의미한 read 시스템콜을 계속 호출하게 두는 것이다.</p>
<p>따라서, 실험용 프로그램은 이렇게 짤 수 있을 것이다. 이제는 <strong>시스템 콜을 올바르게 정의했는지</strong>를 테스트할 수 있다.</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span style="color:light-dark(#A0ADA0, #758575DD); --shiki-dark:#758575DD;">// h1_readcount.c</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">#</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">include</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;"> "</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">kernel/types.h</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">#</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">include</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;"> "</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">kernel/fcntl.h</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">#</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">include</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;"> "</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">kernel/stat.h</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">#</span><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">include</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;"> "</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">user/user.h</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">int</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">main</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">int</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;"> argc</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> char</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> *</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">argv</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">[]</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">{</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> nproc </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 4</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">  int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> loops </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 10000</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  if</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">argc </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">==</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 3</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">){</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">    nproc </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> atoi</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">argv</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">[</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">1</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">]);</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">    loops </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> atoi</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#B07D48, #BD976A); --shiki-dark:#BD976A;">argv</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">[</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">2</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">]);</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  uint64 before </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> getreadcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  for</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> i </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> i </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">&#x3C;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> nproc</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> i</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">++</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">){</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">    if</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">fork</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">()</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> ==</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">){</span></span>
<span class="line"><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">      char</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> dummy</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">      for</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> j </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> j </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">&#x3C;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> loops</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> j</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">++</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">){</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">        read</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;"> &#x26;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">dummy</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">      exit</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  for</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">int</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> i </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;"> 0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> i </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">&#x3C;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> nproc</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> i</span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">++</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">    wait</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  uint64 after </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;"> getreadcount</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">();</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  uint64 delta </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> after </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">-</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> before</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">  uint64 expected </span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">=</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> (</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">uint64</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">nproc </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">*</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;"> (</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">uint64</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">loops</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  printf</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">before=</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">%lu</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> after=</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">%lu</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> delta=</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">%lu</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;"> expected=</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">%lu\n</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span></span>
<span class="line"><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">         before</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> after</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> delta</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">,</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> expected</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  if</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;">delta </span><span style="color:light-dark(#AB5959, #CB7676); --shiki-dark:#CB7676;">==</span><span style="color:light-dark(#393A34, #DBD7CAEE); --shiki-dark:#DBD7CAEE;"> expected</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">)</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">    printf</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">PASS: atomic increments</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">\n</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#1E754F, #4D9375); --shiki-dark:#4D9375;">  else</span></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">    printf</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#B56959, #C98A7D); --shiki-dark:#C98A7D;">FAIL: lost increments</span><span style="color:light-dark(#A65E2B, #C99076); --shiki-dark:#C99076;">\n</span><span style="color:light-dark(#B5695977, #C98A7D77); --shiki-dark:#C98A7D77;">"</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:light-dark(#59873A, #80A665); --shiki-dark:#80A665;">  exit</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">(</span><span style="color:light-dark(#2F798A, #4C9A91); --shiki-dark:#4C9A91;">0</span><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">);</span></span>
<span class="line"><span style="color:light-dark(#999999, #666666); --shiki-dark:#666666;">}</span></span></code></pre>
<p><strong><code>_Atomic</code></strong> 지시어를 추가하지 않은 버전의 실행결과</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=22 after=100021 delta=99999 expected=100000</span></span>
<span class="line"><span>FAIL: lost increments</span></span>
<span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=100043 after=200042 delta=99999 expected=100000</span></span>
<span class="line"><span>FAIL: lost increments</span></span>
<span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=200064 after=300063 delta=99999 expected=100000</span></span>
<span class="line"><span>FAIL: lost increments</span></span></code></pre>
<p><strong><code>_Atomic</code></strong> 지시어를 추가한 버전의 실행결과</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:light-dark(#ffffff, #121212); --shiki-dark-bg:#121212; color:light-dark(#393a34, #dbd7caee); --shiki-dark:#dbd7caee;"><code><span class="line"><span>$ h1_readcount 100 1000</span></span>
<span class="line"><span>before=22 after=61022 delta=61000 expected=100000</span></span>
<span class="line"><span>FAIL: lost increments</span></span>
<span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=61044 after=161044 delta=100000 expected=100000</span></span>
<span class="line"><span>PASS: atomic increments</span></span>
<span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=161066 after=261066 delta=100000 expected=100000</span></span>
<span class="line"><span>PASS: atomic increments</span></span>
<span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=261088 after=361088 delta=100000 expected=100000</span></span>
<span class="line"><span>PASS: atomic increments</span></span>
<span class="line"><span>$ h1_readcount 10 10000</span></span>
<span class="line"><span>before=361110 after=461110 delta=100000 expected=100000</span></span></code></pre>
<p>따라서, <code>readcount</code> 변수 선언부에 <strong><code>_Atomic</code></strong> 지시어를 추가하는 것으로, 여러 프로세스에서 read 시스템콜을 호출하더라도 <code>readcount</code>가 원자적으로 증가하는 것을 보장할 수 있었고, <code>getreadcount</code> 시스템 콜에서도 정확히 read 시스템 콜을 호출한 수만큼 값이 반환되는 것을 확인할 수 있었다.</p>
<h3 id="0198a420-d5a2-7cac-8635-95b91fd889ba--정리">정리 <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--정리"><span aria-hidden="true"></span></a></h3>
<ul>
<li><strong><code>_Atomic</code></strong> 지시어를 사용해 다중 프로세스 환경에서도 readcount 증가의 원자성을 확보했다.</li>
<li>xv6의 시스템 콜 정의 구조(<strong>syscall.h</strong>, <strong>syscall.c</strong>, <strong><a href="http://usys.pl">usys.pl</a></strong> ...)를 직접 손보며 전체 흐름을 익혔다.</li>
</ul>
<p>위의 삽질의 흔적들은 <a href="https://github.com/malkoG/xv6-riscv/tree/h1-getreadcount">https://github.com/malkoG/xv6-riscv/tree/h1-getreadcount</a> 여기에서 구경이 가능하다.</p>
<h2 id="0198a420-d5a2-7cac-8635-95b91fd889ba--reference">Reference <a class="header-anchor" href="#0198a420-d5a2-7cac-8635-95b91fd889ba--reference"><span aria-hidden="true"></span></a></h2>
<ul>
<li>_Atomic 타입 지시어에 대한 설명 : <a href="https://en.cppreference.com/w/c/language/atomic.html">https://en.cppreference.com/w/c/language/atomic.html</a></li>
<li>RISC-V 어셈블리에서 시스템 콜을 호출할때 시스템 콜 번호를 왜 a7 레지스터에 적재하는지에 대해 설명되어 있다. <a href="https://man7.org/linux/man-pages/man2/syscall.2.html">https://man7.org/linux/man-pages/man2/syscall.2.html</a></li>
<li>RISC-V 어셈블리 코드를 해석하는 데 있어서 도움이 되었던 Cheatsheet : <a href="https://projectf.io/posts/riscv-cheat-sheet/">https://projectf.io/posts/riscv-cheat-sheet/</a></li>
</ul>

    </div>

  <div class="mt-8 pt-6 border-t">
    <a
      href="https://hackers.pub/@kodingwarrior/2025/ostep-%EB%8F%85%ED%95%99-%EC%9D%BC%EC%A7%80-h-1"
      target="_blank"
      rel="noopener noreferrer"
      class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors"
    >
      hackers.pub에서 보기 ->
    </a>
  </div>
</article>

          </article>
        </main>

        <div class="sticky left-0 w-screen top-4 z-10 hidden 2xl:block">
            <div class="toc-layer">
                <div class="toc-aside">
                </div>
                <div class="toc-padding">
                </div>
                <div class="toc-aside">
                    
                </div>
            </div>
        </div>
    </div>

    <footer class="flex justify-start sm:justify-center flex-col sm:flex-row">
  <a class="my-2 mx-3 no-underline" href="/rss.xml">
    <i class="bi bi-rss-fill text-2xl"></i> Feed
  </a>
  <a class="my-2 mx-3 no-underline" href="mailto:rijgndqw012@gmail.com">
    <i class="bi bi-envelope-fill text-2xl"></i> Email
  </a>
  <a class="my-2 mx-3 no-underline" href="https://twitter.com/kodingwarrior">
    <i class="bi bi-twitter text-2xl"></i> Twitter
  </a>
  <a class="my-2 mx-3 no-underline" href="https://github.com/kodingwarrior/kodingwarrior.github.io">
    <i class="bi bi-github text-2xl"></i> Github
  </a>
</footer>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-127979309-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-127979309-1');
    </script>
  </body>
</html>
